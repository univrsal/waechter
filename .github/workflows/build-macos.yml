name: Build (macOS Client)

on:
  push:
    branches: [ master ]
    paths:
      - 'Source/Gui/**'
      - 'Source/Util/**'
      - 'Thirdparty/**'
      - 'CMakeLists.txt'
      - '**/CMakeLists.txt'
      - '**/*.cmake'
      - '.github/workflows/build-macos.yml'
  pull_request:
    branches: [ master ]
    paths:
      - 'Source/Gui/**'
      - 'Source/Util/**'
      - 'Thirdparty/**'
      - 'CMakeLists.txt'
      - '**/CMakeLists.txt'
      - '**/*.cmake'
      - '.github/workflows/build-macos.yml'
  workflow_dispatch:
  release:
    types: [created]

jobs:
  build-macos:
    runs-on: macos-15
    strategy:
      matrix:
        target: [arm64, x86_64]
    defaults:
      run:
        shell: zsh --no-rcs --errexit --pipefail {0}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Set Up Environment
        id: setup
        run: |

          sudo xcode-select --switch /Applications/Xcode_26.1.app/Contents/Developer

          local -a unwanted_formulas=()
          local -a remove_formulas=()
          for formula (${unwanted_formulas}) {
            if [[ -d ${HOMEBREW_PREFIX}/Cellar/${formula} ]] remove_formulas+=(${formula})
          }

          if (( #remove_formulas )) brew uninstall --ignore-dependencies ${remove_formulas}

          local -A arch_names=(x86_64 intel arm64 apple)
          print "cpuName=${arch_names[${{ matrix.target }}]}" >> $GITHUB_OUTPUT

          local xcode_cas_path="${HOME}/Library/Developer/Xcode/DerivedData/CompilationCache.noindex"

          if ! [[ -d ${xcode_cas_path} ]] mkdir -p ${xcode_cas_path}

          print "xcodeCasPath=${xcode_cas_path}" >> $GITHUB_OUTPUT

      - name: Install dependencies via Homebrew
        run: |
          brew update
          if [[ "${{ matrix.target }}" == "x86_64" ]]; then
            # Install x86_64 Homebrew and dependencies for cross-compilation
            arch -x86_64 /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)" || true
            arch -x86_64 /usr/local/bin/brew install cmake zlib libwebsockets
          else
            brew install cmake zlib libwebsockets
          fi

      - name: Configure (CMake + Ninja)
        run: |
          if [[ "${{ matrix.target }}" == "x86_64" ]]; then
            # Use x86_64 Homebrew prefix for finding libraries
            export CMAKE_PREFIX_PATH="/usr/local"
            cmake -S . -B build -G Ninja \
              -DCMAKE_BUILD_TYPE=Release \
              -DCMAKE_OSX_ARCHITECTURES=${{ matrix.target }} \
              -DCMAKE_INSTALL_PREFIX="${{ github.workspace }}/install" \
              -DWAECHTER_BUILD_DAEMON=OFF \
              -DWAECHTER_BUILD_CLIENT=ON \
              -DCMAKE_PREFIX_PATH="/usr/local"
          else
            cmake -S . -B build -G Ninja \
              -DCMAKE_BUILD_TYPE=Release \
              -DCMAKE_OSX_ARCHITECTURES=${{ matrix.target }} \
              -DCMAKE_INSTALL_PREFIX="${{ github.workspace }}/install" \
              -DWAECHTER_BUILD_DAEMON=OFF \
              -DWAECHTER_BUILD_CLIENT=ON
          fi

      - name: Build
        run: |
          cmake --build build --config Release

      - name: Install
        run: |
          cmake --install build --prefix install

      - name: Get short commit
        run: |
          echo "SHORT_SHA=$(git rev-parse --short HEAD)" >> "$GITHUB_ENV"

      - name: Create .app bundle structure
        run: |
          mkdir -p "Waechter.app/Contents/MacOS"
          mkdir -p "Waechter.app/Contents/Resources"

          # Copy executable
          cp install/bin/waechter "Waechter.app/Contents/MacOS/"

          # Copy icon (convert PNG to ICNS if needed)
          if command -v sips &> /dev/null; then
            mkdir -p icon.iconset
            sips -z 16 16     Meta/Assets/Branding/Icon.png --out icon.iconset/icon_16x16.png
            sips -z 32 32     Meta/Assets/Branding/Icon.png --out icon.iconset/icon_16x16@2x.png
            sips -z 32 32     Meta/Assets/Branding/Icon.png --out icon.iconset/icon_32x32.png
            sips -z 64 64     Meta/Assets/Branding/Icon.png --out icon.iconset/icon_32x32@2x.png
            sips -z 128 128   Meta/Assets/Branding/Icon.png --out icon.iconset/icon_128x128.png
            sips -z 256 256   Meta/Assets/Branding/Icon.png --out icon.iconset/icon_128x128@2x.png
            sips -z 256 256   Meta/Assets/Branding/Icon.png --out icon.iconset/icon_256x256.png
            sips -z 512 512   Meta/Assets/Branding/Icon.png --out icon.iconset/icon_256x256@2x.png
            sips -z 512 512   Meta/Assets/Branding/Icon.png --out icon.iconset/icon_512x512.png
            cp Meta/Assets/Branding/Icon.png icon.iconset/icon_512x512@2x.png
            iconutil -c icns icon.iconset -o "Waechter.app/Contents/Resources/waechter.icns"
          else
            cp Meta/Icon.png "Waechter.app/Contents/Resources/"
          fi

          # Create Info.plist
          cat > "Waechter.app/Contents/Info.plist" << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>CFBundleDevelopmentRegion</key>
              <string>en</string>
              <key>CFBundleExecutable</key>
              <string>waechter</string>
              <key>CFBundleIconFile</key>
              <string>waechter.icns</string>
              <key>CFBundleIdentifier</key>
              <string>st.waechter.client</string>
              <key>CFBundleInfoDictionaryVersion</key>
              <string>6.0</string>
              <key>CFBundleName</key>
              <string>Waechter</string>
              <key>CFBundlePackageType</key>
              <string>APPL</string>
              <key>CFBundleShortVersionString</key>
              <string>0.1.3</string>
              <key>CFBundleVersion</key>
              <string>1</string>
              <key>LSMinimumSystemVersion</key>
              <string>11.0</string>
              <key>NSHighResolutionCapable</key>
              <true/>
          </dict>
          </plist>
          EOF

      - name: Code sign (if secrets available)
        if: github.event_name == 'release' || github.event_name == 'push'
        env:
          MACOS_CERTIFICATE: ${{ secrets.MACOS_CERTIFICATE }}
          MACOS_CERTIFICATE_PWD: ${{ secrets.MACOS_CERTIFICATE_PWD }}
          MACOS_SIGNING_IDENTITY: ${{ secrets.MACOS_SIGNING_IDENTITY }}
        run: |
          if [ -n "$MACOS_CERTIFICATE" ] && [ -n "$MACOS_CERTIFICATE_PWD" ]; then
            echo "Setting up code signing..."
            echo "$MACOS_CERTIFICATE" | base64 --decode > certificate.p12
            security create-keychain -p actions build.keychain
            security default-keychain -s build.keychain
            security unlock-keychain -p actions build.keychain
            security import certificate.p12 -k build.keychain -P "$MACOS_CERTIFICATE_PWD" -T /usr/bin/codesign
            security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k actions build.keychain

            # Sign the app
            codesign --force --deep --sign "$MACOS_SIGNING_IDENTITY" --options runtime "Waechter.app"

            # Verify
            codesign --verify --verbose "Waechter.app"

            # Cleanup
            rm certificate.p12
            security delete-keychain build.keychain
            echo "Code signing completed"
          else
            echo "Code signing skipped - certificate secrets not configured"
          fi

      - name: Create PKG installer
        run: |
          # Create package structure
          mkdir -p pkgroot/Applications
          cp -R Waechter.app pkgroot/Applications/

          # Create component package
          pkgbuild --root pkgroot \
                   --identifier st.waechter.client \
                   --version 0.1.3 \
                   --install-location / \
                   component.pkg

          # Create distribution XML
          cat > distribution.xml << 'EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <installer-gui-script minSpecVersion="1">
              <title>Waechter Network Monitor</title>
              <organization>st.waechter</organization>
              <domains enable_localSystem="true"/>
              <options customize="never" require-scripts="false"/>
              <pkg-ref id="st.waechter.client"/>
              <choices-outline>
                  <line choice="default">
                      <line choice="st.waechter.client"/>
                  </line>
              </choices-outline>
              <choice id="default"/>
              <choice id="st.waechter.client" visible="false">
                  <pkg-ref id="st.waechter.client"/>
              </choice>
              <pkg-ref id="st.waechter.client" version="0.1.3" onConclusion="none">component.pkg</pkg-ref>
          </installer-gui-script>
          EOF

          # Create product archive (final PKG)
          productbuild --distribution distribution.xml \
                       --package-path . \
                       "waechter-${{ matrix.target }}-${{ env.SHORT_SHA }}.pkg"

      - name: Sign PKG (if secrets available)
        if: github.event_name == 'release' || github.event_name == 'push'
        env:
          MACOS_INSTALLER_CERTIFICATE: ${{ secrets.MACOS_INSTALLER_CERTIFICATE }}
          MACOS_INSTALLER_CERTIFICATE_PWD: ${{ secrets.MACOS_INSTALLER_CERTIFICATE_PWD }}
          MACOS_INSTALLER_SIGNING_IDENTITY: ${{ secrets.MACOS_INSTALLER_SIGNING_IDENTITY }}
        run: |
          if [ -n "$MACOS_INSTALLER_CERTIFICATE" ] && [ -n "$MACOS_INSTALLER_CERTIFICATE_PWD" ]; then
            echo "Setting up installer signing..."
            echo "$MACOS_INSTALLER_CERTIFICATE" | base64 --decode > installer.p12
            security create-keychain -p actions build.keychain
            security default-keychain -s build.keychain
            security unlock-keychain -p actions build.keychain
            security import installer.p12 -k build.keychain -P "$MACOS_INSTALLER_CERTIFICATE_PWD" -T /usr/bin/productsign
            security set-key-partition-list -S apple-tool:,apple:,productsign: -s -k actions build.keychain

            # Sign the PKG
            productsign --sign "$MACOS_INSTALLER_SIGNING_IDENTITY" \
                        "waechter-${{ matrix.target }}-${{ env.SHORT_SHA }}.pkg" \
                        "waechter-${{ matrix.target }}-${{ env.SHORT_SHA }}-signed.pkg"

            mv "waechter-${{ matrix.target }}-${{ env.SHORT_SHA }}-signed.pkg" \
               "waechter-${{ matrix.target }}-${{ env.SHORT_SHA }}.pkg"

            # Cleanup
            rm installer.p12
            security delete-keychain build.keychain
            echo "PKG signing completed"
          else
            echo "PKG signing skipped - certificate secrets not configured"
          fi

      - name: Upload Artifacts (PKG)
        uses: actions/upload-artifact@v4
        with:
          name: waechter-macos-${{ matrix.target }}-${{ env.SHORT_SHA }}
          path: waechter-${{ matrix.target }}-${{ env.SHORT_SHA }}.pkg
          if-no-files-found: error

      - name: Upload to Release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v1
        with:
          files: waechter-${{ matrix.target }}-${{ env.SHORT_SHA }}.pkg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
