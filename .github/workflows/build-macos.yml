name: Build (macOS Client)

on:
  push:
    branches: [ master ]
    paths:
      - 'Source/Gui/**'
      - 'Source/Util/**'
      - 'Thirdparty/**'
      - 'CMakeLists.txt'
      - '**/CMakeLists.txt'
      - '**/*.cmake'
      - '.github/workflows/build-macos.yml'
  pull_request:
    branches: [ master ]
    paths:
      - 'Source/Gui/**'
      - 'Source/Util/**'
      - 'Thirdparty/**'
      - 'CMakeLists.txt'
      - '**/CMakeLists.txt'
      - '**/*.cmake'
      - '.github/workflows/build-macos.yml'
  workflow_dispatch:
  release:
    types: [created]

jobs:
  build-macos:
    runs-on: macos-15
    strategy:
      matrix:
        target: [arm64, x86_64]
    defaults:
      run:
        shell: zsh --no-rcs --errexit --pipefail {0}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Set Up Environment
        id: setup
        run: .github/scripts/macos/setup.sh
        env:
          TARGET_ARCH: ${{ matrix.target }}

      - name: Configure (CMake + Ninja)
        run: .github/scripts/macos/configure.sh
        env:
          TARGET_ARCH: ${{ matrix.target }}
          WORKSPACE: ${{ github.workspace }}

      - name: Build
        run: .github/scripts/macos/build.sh

      - name: Get short commit
        run: |
          echo "SHORT_SHA=$(git rev-parse --short HEAD)" >> "$GITHUB_ENV"

      - name: Get current version
        run: |
          # Extract from CMakeLists "project(waechter VERSION 0.1.3 LANGUAGES C CXX)"
          VERSION_LINE=$(grep -E '^project\(waechter VERSION ' CMakeLists.txt)
          VERSION=$(echo $VERSION_LINE | sed -E 's/project\(waechter VERSION ([0-9]+\.[0-9]+\.[0-9]+).*/\1/')
          echo "VERSION=$VERSION" >> "$GITHUB_ENV"

      - name: Create .app bundle structure
        run: .github/scripts/macos/create-app-bundle.sh

      - name: Create PKG installer
        run: .github/scripts/macos/create-pkg.sh ${{ matrix.target }} ${{ env.SHORT_SHA }}

      - name: Code sign (if secrets available)
        if: github.event_name == 'release'
        run: .github/scripts/macos/sign.sh ${{ matrix.target }} ${{ env.SHORT_SHA }}
        env:
          MACOS_INSTALLER_CERTIFICATE: ${{ secrets.MACOS_INSTALLER_CERTIFICATE }}
          MACOS_INSTALLER_CERTIFICATE_PWD: ${{ secrets.MACOS_INSTALLER_CERTIFICATE_PWD }}
          MACOS_INSTALLER_SIGNING_IDENTITY: ${{ secrets.MACOS_INSTALLER_SIGNING_IDENTITY }}

      - name: Upload Artifacts (PKG)
        uses: actions/upload-artifact@v4
        with:
          name: waechter-macos-${{ matrix.target }}-${{ env.SHORT_SHA }}
          path: waechter-${{ matrix.target }}-${{ env.SHORT_SHA }}.pkg
          if-no-files-found: error

      - name: Upload to Release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v1
        with:
          files: waechter-${{ matrix.target }}-${{ env.SHORT_SHA }}.pkg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
