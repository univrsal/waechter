name: Build (Ubuntu)

on:
  push:
    branches: [ master ]
    paths:
      - 'Source/**'
      - 'Thirdparty/**'
      - 'CMakeLists.txt'
      - '**/CMakeLists.txt'
      - '**/*.cmake'
  pull_request:
    branches: [ master ]
    paths:
      - 'Source/**'
      - 'Thirdparty/**'
      - 'CMakeLists.txt'
      - '**/CMakeLists.txt'
      - '**/*.cmake'
  workflow_dispatch:

jobs:
  build:
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          - arch: x86_64
            runner: ubuntu-latest
          - arch: arm64
            runner: ubuntu-24.04-arm
    env:
      # keep ccache inside the repository workspace so the actions/cache step can store it reliably
      CCACHE_DIR: ${{ github.workspace }}/.ccache

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: .github/scripts/install-dependencies.sh

      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: ./.ccache
          key: ${{ runner.os }}-${{ matrix.arch }}-ccache-${{ hashFiles('**/CMakeLists.txt', '**/*.cpp', '**/*.c', '**/*.h') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.arch }}-ccache-

      - name: Cache CMake build directory (optional)
        uses: actions/cache@v4
        with:
          # caching the entire build dir can speed up incremental builds but may be fragile across toolchain changes
          path: build
          key: ${{ runner.os }}-${{ matrix.arch }}-cmake-build-${{ hashFiles('CMakeLists.txt', '**/CMakeLists.txt', '**/*.cmake', 'Source/**', 'Thirdparty/**') }}

      - name: Show ccache stats (before)
        run: |
          ccache --version || true
          ccache -s || true

      - name: Install bpftool for ARM64
        if: matrix.arch == 'arm64'
        run: |
          # ARM64 runners may not have bpftool in linux-tools-common
          # Install bpftool from source or use generic version
          sudo apt-get install -y linux-tools-generic linux-tools-azure linux-cloud-tools-azure|| true
          # If still not available, build from source
          if ! command -v bpftool &> /dev/null; then
            echo "Building bpftool from source..."
            git clone --depth 1 --branch v6.1 https://github.com/libbpf/bpftool.git
            cd bpftool/src
            make -j$(nproc)
            sudo make install
            cd ../..
          fi

      - name: Configure (CMake + Ninja)
        run: |
          cmake -S . -B build -G Ninja -DCMAKE_BUILD_TYPE=RelWithDebInfo -DCMAKE_INSTALL_PREFIX="$GITHUB_WORKSPACE/artifacts" \
            -DCMAKE_C_COMPILER_LAUNCHER=ccache -DCMAKE_CXX_COMPILER_LAUNCHER=ccache

      - name: Build
        run: |
          cmake --build build --config Release -- -k 0

      - name: Show ccache stats (after)
        run: |
          ccache -s || true

      - name: Package (Install)
        run: |
          cmake --install build --prefix artifacts || true

      - name: Package (DEB)
        run: |
          cd build
          cpack -G DEB

      - name: Get short commit
        run: |
          # put the short git commit into the Actions environment so it can be used in later steps
          echo "SHORT_SHA=$(git rev-parse --short HEAD)" >> "$GITHUB_ENV"

      - name: Upload Artifacts (Installed Files)
        uses: actions/upload-artifact@v4
        with:
          name: waechter-ubuntu-${{ matrix.arch }}-${{ env.SHORT_SHA }}
          path: artifacts
          if-no-files-found: ignore

      - name: Upload Artifacts (DEB Package)
        uses: actions/upload-artifact@v4
        with:
          name: waechter-deb-${{ matrix.arch }}-${{ env.SHORT_SHA }}
          path: build/*.deb
          if-no-files-found: error

